<!DOCTYPE html>

<html>
	<head>
        <title>VISS MANAGER - AGT Request</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="icon" href="images/favicon.ico">
        <link rel="stylesheet" href="/styles/menu.css" type="text/css">
		<link rel="stylesheet" href="/styles/general.css" type="text/css">
		<script src="wasm_exec.js"></script>
		<script> //type="module"
			//import axios from 'axios': USED TO FETCH WHEN NOT USING WEB SERVER
			const go = new Go();
			//WebAssembly.instantiateStreaming(axios.get("scripts/go/lib.wasm"), go.importObject).then((result) => {
			WebAssembly.instantiateStreaming(fetch("scripts/go/lib.wasm"), go.importObject).then((result) => {
				go.run(result.instance);
			});
		</script>
        <script src = "scripts/js/encoding.js"></script>
	</head>
	<body>
        <script src = "scripts/js/menu.js"></script>
		<h2>Access Grant Token Client</h2><br>


        <div id = gt_opts class="vert_select_list">
            <p class="subject">Grant Token Request</p>
            <div class = "row">
                <div class = "column">
                    <label for="vin">Vehicle Number</label>
                    <br><input id="vin" type="text" placeholder="GEO001"/>
                    <br><label for="proof">Proof:</label>
                    <br><input id="proof" type="text" value = "ABC" placeholder="ABC (not yet implemented)"/>
                    <br><label for="sign_type" name>Signature Type</label>
                    <br><select id = "sign_type" name = "sign_type">
                        <option value = "None">None</option>
                        <option value = "RS256">RS256</option>
                        <option value = "ES256">ES256</option>
                    </select>  
                </div>
                <div class = "column">
                    <label for="user_role">User Role</label> 
                    <br><select id = "user_role" name = "user_role">
                        <option value = "Dealer">Dealer</option>
                        <option value = "OEM">OEM</option>
                        <option value = "Independent">Independent</option>
                        <option value = "Owner">Owner</option>
                        <option value = "Driver">Driver</option>
                        <option value = "Passenger">Passenger</option>
                    </select>
                    <br> <label for="app_role">App Role</label>
                    <br><select id="app_role" name = "app_role">
                        <option value = "OEM">OEM</option>
                        <option value = "Third party">Third Party</option>
                    </select>
                    <br><label for="dev_role">Device Role</label>
                    <br><select id="dev_role" name = "dev_role">
                        <option value = "Vehicle">Vehicle</option>
                        <option value = "Nomadic">Nomadic</option>
                        <option value = "Cloud">Cloud</option>
                    </select> 
                </div>
                <div class="column">
                    <div id = pop_opts style="display:none">
                        <label for="pop_jti">JTI</label>
                        <br><input id = "pop_jti" type = "text" value = "auto" placeholder = "default: auto">
                        <br><label for="pop_aud">AUD</label>
                        <br><input id = "pop_aud" type = "text" value = "vissv2/agts" placeholder = "default: vissv2/agts">
                        <br><label for = "pop_iat">IAT</label>
                        <br><input id = "pop_iat" type = "text" value = "auto" placeholder = "auto, +1, -1, 123">
                        <br><label for = "jwk_thumb" style="display:none;"><b>Public Key</b></label>
                        <br><output id = "jwk_thumb" type = "text" style="display: none;"></output>
                    </div>            
                </div>  
            </div>
                </div>

                <div class="horiz_click_list">
                    <br><button onclick="sendAgtReq()" class="arrow_button"><span>Send</span></button> 
                    <input type="checkbox" id="log_switch" checked>
                    <span>Logs</span>
                </div>
        
                <div class="data_box" id="logs">
                    <p class="subject">Logs<br></p> 
                    <p id="log_data" class="data"></p>
                    <button onclick="logReset()">Reset</button>
                </div>


        
                <p id = "agReq" style="display:none"></p>
                <p id = "agPop" style="display:none"></p>
                <p id = "agResp" style="display:none"></p>  
            </div>
        </div>

        <!-- Script for style changes and logs-->
        <script src = "scripts/js/logs.js"></script>
        <script>
            document.getElementById("sign_type").addEventListener("change", showPopOpts)
            document.getElementById("log_switch").addEventListener("input", showLogs)

            function showPopOpts() {
                if (document.getElementById("sign_type").value == "" || document.getElementById("sign_type").value == "None"){
                    document.getElementById("pop_opts").style.display = "none"
                } else{
                    document.getElementById("pop_opts").style.display = "block"
                }
            }
        </script>

        <!-- Request maker-->
        <script>
            // AGT Requester
            var agtURL = 'http://150.214.47.151:61057/agts';
            //var agtURL = 'http://127.0.0.1:7500/agts';
            var agReq = document.getElementById("agReq");
            var agPop = document.getElementById("agPop");
            var agResp = document.getElementById("agResp");
            var key_thumb;

            function genAgtReq() {
                let req;
                req = jsonRecursiveEncoding("vin", document.getElementById("vin").value, "");
                req = jsonRecursiveEncoding("context",document.getElementById("user_role").value + "+"
                + document.getElementById("app_role").value + "+" + document.getElementById("dev_role").value, req);
                req = jsonRecursiveEncoding("proof", document.getElementById("proof").value, req);
                return req;
            }
            
            try {
                function sendAgtReq(){
                    let xhttpreq = new XMLHttpRequest();
                    xhttpreq.onreadystatechange = function(){
                        if(this.readyState == 4){
                            if (this.status != 200){
                                logStatus("Error", "HTTP Request status: "+this.status+",data: "+this.statusText);
                            } else{
                                if (this.responseText.length > 55){
                                    logStatus("Info", "HTTP Response received: "+this.responseText.slice(0, 55)+ "...");
                                } else{
                                    logStatus("Info", "HTTP Response received: "+this.responseText);
                                }
                                
                                agResp.textContent = "Response: " + this.responseText;
                            }
                            agResp.style.display = "block";
                        }
                    }

                    xhttpreq.open("POST", agtURL, true);
                    //xhttpreq.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
                    let req = genAgtReq();
                    logStatus("Info", "Request Body Generated")

                    if (((document.getElementById("sign_type").value == "RS256")&&(localStorage.rsaKey != null )) || 
                    ((document.getElementById("sign_type").value == "ES256")&&(localStorage.ecdsaKey != null ))) {
                        logStatus("Info", "Generating POP")
                        let pop = generatePop()
                        if (pop != ""){
                            xhttpreq.setRequestHeader("PoP", pop);
                            req = jsonRecursiveEncoding("key", document.getElementById("jwk_thumb").textContent, req);
                            logStatus("Info", "POP generated correctly")
                        } else {
                            logStatus("Error", "POP could not be generated")
                            return 
                        }
                    } else {
                        logStatus("Info", "POP not used, expecting not long term token")
                    }
                    agReq.textContent = req;
                    agReq.style.display = "block";
                    logStatus("Info", "Sending AGT Request")
                    xhttpreq.send(req);
                }
            } catch(err){
                logStatus("Error", err.message)
            }
        </script>
    </body>
</html>